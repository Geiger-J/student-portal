<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${title} ?: 'Student Portal'">Student Portal</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" href="/css/styles.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>
<body>

<!-- Header Fragment -->
<header class="header" th:fragment="header">
    <div class="container header-flex">
        <h1 class="site-title">
            <a th:href="@{/dashboard}" sec:authorize="isAuthenticated()">🎓 Bromsgrove Student Portal</a>
            <a th:href="@{/}" sec:authorize="isAnonymous()">🎓 Bromsgrove Student Portal</a>
        </h1>

        <!-- Authenticated Navigation -->
        <nav class="main-nav" sec:authorize="isAuthenticated()">
            <a th:href="@{/dashboard}"
               th:classappend="${#httpServletRequest.requestURI == '/dashboard'} ? 'active' : ''">📊 Dashboard</a>
            <a th:href="@{/profile}"
               th:classappend="${#strings.startsWith(#httpServletRequest.requestURI, '/profile')} ? 'active' : ''">👤 Profile</a>
            <a th:href="@{/subjects}"
               th:classappend="${#strings.startsWith(#httpServletRequest.requestURI, '/subjects')} ? 'active' : ''">📚 Subjects</a>
            <a th:href="@{/availability}"
               th:classappend="${#strings.startsWith(#httpServletRequest.requestURI, '/availability')} ? 'active' : ''">📅 Availability</a>
            <a th:href="@{/requests}"
               th:classappend="${#strings.startsWith(#httpServletRequest.requestURI, '/requests')} ? 'active' : ''">📝 Requests</a>
            <a th:href="@{/matches}"
               th:classappend="${#strings.startsWith(#httpServletRequest.requestURI, '/matches')} ? 'active' : ''">🤝 Matches</a>

            <!-- Admin Dropdown -->
            <div sec:authorize="hasRole('ADMIN')" class="admin-dropdown">
                <a href="#" class="dropdown-toggle" onclick="toggleDropdown(event)">⚙️ Admin ▼</a>
                <div class="dropdown-menu">
                    <a th:href="@{/admin}">📈 Overview</a>
                    <a th:href="@{/admin/matching}">🚀 Matching</a>
                    <a th:href="@{/subjects/admin}">📚 Manage Subjects</a>
                </div>
            </div>

            <!-- Secure Logout (POST) -->
            <form th:action="@{/logout}" method="post" class="logout-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="logout-btn">🚪 Logout</button>
            </form>
        </nav>

        <!-- Anonymous Navigation -->
        <nav class="main-nav" sec:authorize="isAnonymous()">
            <a class="auth-btn" th:href="@{/login}">🔐 Sign In</a>
            <a class="auth-btn primary" th:href="@{/register}">📝 Register</a>
        </nav>
    </div>
</header>

<!-- Head Fragment -->
<head th:fragment="head">
    <meta charset="UTF-8"/>
    <title th:text="${title} ?: 'Student Portal'">Student Portal</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" href="/css/styles.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>

<script th:inline="javascript">
/* Simple dropdown toggle */
function toggleDropdown(e){
    e.preventDefault();
    const menu = e.target.closest('.admin-dropdown').querySelector('.dropdown-menu');
    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    document.addEventListener('click', function handler(ev){
        if(!e.target.closest('.admin-dropdown').contains(ev.target)){
            menu.style.display='none';
            document.removeEventListener('click', handler);
        }
    });
}
</script>
</body>
</html>