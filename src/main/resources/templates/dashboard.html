<!DOCTYPE html>
<!--
Central dashboard for consolidated student portal experience.
Displays user overview, requests management, and active matches.
Integrates formerly separate functionality into unified interface.
Provides quick actions and comprehensive status monitoring.
-->
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/header :: head"></head>
<body>
<header th:replace="fragments/header :: header"></header>
<main class="container">
    <h2>Dashboard</h2>
    
    <!-- Welcome Section -->
    <section class="welcome-section">
        <h3>Welcome, <span th:text="${user.fullName}">Student</span>!</h3>
        <div th:if="${user.yearGroup == null or user.examBoard == null}">
            <div class="alert alert-warning">
                Please complete your profile (Year Group / Exam Board) for better matches.
                <a th:href="@{/profile}">Update profile</a>.
            </div>
        </div>
        <div th:if="${user.yearGroup != null and user.examBoard != null}">
            <div class="alert alert-success">
                Profile academic details set. You're ready for matching.
            </div>
        </div>
    </section>
    
    <!-- Quick Stats -->
    <section class="stats-section">
        <div class="stats-grid">
            <article class="stat-card">
                <h4>Profile Complete</h4>
                <span class="stat-value" th:text="${profileScore} + '%'">0%</span>
                <div class="progress-bar">
                    <div class="progress-fill" th:style="'width: ' + ${profileScore} + '%'"></div>
                </div>
            </article>
            <article class="stat-card">
                <h4>Active Requests</h4>
                <span class="stat-value" th:text="${pendingRequests}">0</span>
            </article>
            <article class="stat-card">
                <h4>Current Matches</h4>
                <span class="stat-value" th:text="${completedMatches}">0</span>
            </article>
            <article class="stat-card">
                <h4>Total Requests</h4>
                <span class="stat-value" th:text="${totalRequests}">0</span>
            </article>
        </div>
    </section>

    <!-- Requests Section -->
    <section class="requests-section" id="requests">
        <h3>My Requests</h3>

        <div th:if="${param.error}">
            <div class="alert alert-danger">
                <span th:if="${param.error[0] == 'notfound'}">Request not found or access denied.</span>
                <span th:if="${param.error[0] == 'cancel'}">Failed to cancel request.</span>
                <span th:if="${param.error[0] == 'complete'}">Failed to complete request.</span>
                <span th:if="${param.error[0] == 'create'}">Failed to create request.</span>
                <span th:if="${param.error[0] == 'notmatched'}">Only matched requests can be completed.</span>
            </div>
        </div>

        <article class="requests-list">
            <h4>Current Requests</h4>
            <div th:if="${#lists.isEmpty(activeRequests)}">
                <p>You don't have any active requests. Create one below to find a tutor or tutee.</p>
            </div>
            
            <div th:if="${!#lists.isEmpty(activeRequests)}">
                <table class="table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Subject</th>
                        <th>Status</th>
                        <th>Timeslots</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="r : ${activeRequests}">
                        <td th:text="${r.id}"></td>
                        <td th:text="${r.type}"></td>
                        <td th:text="${r.subject.name}"></td>
                        <td><span class="badge badge-outstanding" th:text="${r.status}"></span></td>
                        <td>
                            <span th:each="ts : ${r.possibleTimeslots}" th:text="${ts.label}" class="badge timeslot-badge"></span>
                        </td>
                        <td>
                            <form th:action="@{'/requests/cancel/' + ${r.id}}" method="post" style="display:inline;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button class="btn btn-sm btn-danger" type="submit">Cancel</button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </article>

        <article class="request-form">
            <h4>Create New Request</h4>
            <form th:action="@{/dashboard/requests/add}" th:object="${requestForm}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="form-row">
                    <label for="type">Request Type</label>
                    <select id="type" th:field="*{type}">
                        <option th:each="rt : ${requestTypes}" th:value="${rt}" th:text="${rt}"></option>
                    </select>
                </div>
                <div class="form-row">
                    <label for="subjectId">Subject</label>
                    <select id="subjectId" th:field="*{subjectId}">
                        <option th:each="s : ${subjects}" th:value="${s.id}" th:text="${s.name}"></option>
                    </select>
                </div>
                <div class="form-row">
                    <label for="timeslotIds">Preferred Timeslots</label>
                    <select id="timeslotIds" th:field="*{timeslotIds}" multiple size="7">
                        <option th:each="ts : ${timeslots}" th:value="${ts.id}" th:text="${ts.label}"></option>
                    </select>
                </div>
                <div class="form-actions">
                    <button class="btn" type="submit">Create Request</button>
                </div>
            </form>
        </article>
    </section>

    <!-- Matches Section -->
    <section class="matches-section" id="matches">
        <h3>Current Matches</h3>
        
        <div th:if="${#lists.isEmpty(userMatches)}">
            <p>You don't have any current matches. Active requests will be matched during the weekly matching process.</p>
        </div>
        
        <div th:if="${!#lists.isEmpty(userMatches)}">
            <table class="table">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Partner</th>
                        <th>Role</th>
                        <th>Timeslot</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="match : ${userMatches}">
                        <td th:text="${match.tutorRequest.subject.name}">Mathematics</td>
                        <td>
                            <span th:if="${match.tutorRequest.user.id == user.id}" 
                                  th:text="${match.tuteeRequest.user.fullName}">Partner Name</span>
                            <span th:if="${match.tuteeRequest.user.id == user.id}" 
                                  th:text="${match.tutorRequest.user.fullName}">Partner Name</span>
                        </td>
                        <td>
                            <span th:if="${match.tutorRequest.user.id == user.id}" class="badge badge-tutor">Tutor</span>
                            <span th:if="${match.tuteeRequest.user.id == user.id}" class="badge badge-tutee">Tutee</span>
                        </td>
                        <td th:text="${match.matchedTimeslot.label}">Monday Period 1</td>
                        <td>
                            <span class="badge badge-active" th:text="${match.status}">ACTIVE</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-chat" 
                                    th:onclick="'openChat(' + ${match.tutorRequest.id} + ', \'' + (${match.tutorRequest.user.id == user.id} ? ${match.tuteeRequest.user.fullName} : ${match.tutorRequest.user.fullName}) + '\')'">
                                üí¨ Chat
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
    
    <!-- Quick Actions -->
    <section class="actions-section">
        <h3>Quick Actions</h3>
        <nav class="actions-grid">
            <a th:href="@{/profile}" class="action-card">
                <h4>üë§ Update Profile</h4>
                <p>Manage your profile and availability</p>
            </a>
            <a th:href="@{/subjects}" class="action-card">
                <h4>üìö Manage Subjects</h4>
                <p>Add or remove your subjects</p>
            </a>
            <a th:href="@{#requests}" class="action-card">
                <h4>üìù Create Request</h4>
                <p>Find a tutor or offer tutoring</p>
            </a>
            <a sec:authorize="hasRole('ADMIN')" th:href="@{/admin}" class="action-card">
                <h4>‚öôÔ∏è Admin Panel</h4>
                <p>Manage system and matching</p>
            </a>
        </nav>
    </section>

    <!-- Chat Modal (will be implemented in Phase 4) -->
    <div id="chatModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="chatTitle">Chat with Partner</h4>
                <button class="modal-close" onclick="closeChat()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="chatMessages" class="chat-messages">
                    <!-- Messages will be loaded here -->
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Type a message..." />
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
// TODO: Chat system implementation in Phase 4
function openChat(requestId, partnerName) {
    console.log('Opening chat for request:', requestId, 'with:', partnerName);
    // Will be implemented with polling system
}

function closeChat() {
    document.getElementById('chatModal').style.display = 'none';
}

function sendMessage() {
    // Will be implemented with REST API calls
}
</script>
</body>
</html>